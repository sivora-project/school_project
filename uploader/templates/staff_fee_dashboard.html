{% extends "base.html" %}
{% block title %}Staff Fee Dashboard{% endblock %}
{% block content %}

<h4>Staff Fee Dashboard</h4>

<form method="post" class="card p-3 mb-3">
    {% csrf_token %}
    <label>Student PEN Number</label>
    <div class="d-flex gap-2">
        <input type="text" name="student_pen" class="form-control" required>
        <button class="btn btn-primary">Search</button>
    </div>
</form>

{% if error %}
<div class="alert alert-danger">{{ error }}</div>
{% endif %}

{% if student %}
<div class="card p-3 mb-3">
    <h5>{{ student.name }}</h5>
    <p>Father: {{ student.father_name }}</p>
    <p>Class: {{ student.student_class }} - {{ student.section }}</p>
    <p>PEN: {{ student.student_pen }}</p>
</div>

<div class="card p-3 mb-3">
    <table class="table table-bordered">
        <thead>
            <tr>
                <th>Fee Type</th>
                <th>Total</th>
                <th>Paid</th>
                <th>Balance</th>
                <th>Action</th>
            </tr>
        </thead>
        <tbody>
        {% for fee in fee_rows %}
            <tr>
                <td>  {% if fee.fee_head.is_term_fee %}
                        Term {{ fee.term_no }} Fee
                    {% else %}
                        {{ fee.fee_head.fee_name }}
                    {% endif %}</td>
                <td>{{ fee.total_amount }}</td>
                <td>{{ fee.paid_amount }}</td>
                <td>{{ fee.due_amount }}</td>
                <td>
                    {% if fee.due_amount > 0 %}
                        <a href="?pay={{ fee.id }}" class="btn btn-info btn-sm">
                            Pay Now
                        </a>
                    {% else %}
                        <span class="badge bg-success">Paid</span>
                    {% endif %}
                </td>
            </tr>
        {% endfor %}
        </tbody>
    </table>
</div>
{% endif %}

{% if selected_fee %}
<div class="card p-3">
    <h5>Fee Payment</h5>

    <p><b>Fee:</b> {{ selected_fee.fee_head.fee_name }}</p>
    <p><b>Balance:</b> {{ selected_fee.due_amount }}</p>

    <form method="post">
        {% csrf_token %}
        <input type="hidden" name="student_fee_id" value="{{ selected_fee.id }}">

        <label>Amount</label>
        <input type="number" step="0.01" name="amount" class="form-control mb-2" required>

        <label>Payment Mode</label>
        <select name="payment_mode" class="form-control mb-2" onchange="toggleUTR(this.value)">
            <option value="Cash">Cash</option>
            <option value="Non-Cash">Non-Cash</option>
        </select>

        <div id="utrBox" style="display:none;">
            <label>UTR Number</label>
            <input type="text" name="utr_number" class="form-control mb-2">
        </div>

        <button class="btn btn-success">Submit Payment</button>
    </form>
</div>
{% endif %}

<script>
function toggleUTR(value) {
    document.getElementById("utrBox").style.display =
        value === "Non-Cash" ? "block" : "none";
}
</script>

{% endblock %}
