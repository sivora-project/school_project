{% extends "base.html" %}
{% block content %}

<div class="container mt-4">

<h2>ğŸ« School Attendance Dashboard</h2>
<p class="text-muted">{{ snapshot_label }}</p>

<form method="get" class="row g-2 mb-4">

  <!-- SNAPSHOT MODE -->
  <div class="col-md-3">
    <select name="snapshot_mode" class="form-select">
      <option value="month" {% if snapshot_mode == "month" %}selected{% endif %}>Month-wise</option>
      <option value="day" {% if snapshot_mode == "day" %}selected{% endif %}>Day-wise</option>
    </select>
  </div>

  <!-- MONTH -->
  <div class="col-md-3">
    <input type="month" name="snapshot_month"
           value="{{ snapshot_month }}"
           class="form-control">
  </div>

  <!-- DATE -->
  <div class="col-md-3">
    <input type="date" name="snapshot_date"
           value="{{ snapshot_date }}"
           class="form-control">
  </div>

  <!-- CLASS FILTER -->
  <div class="col-md-3">
    <select name="class_name" class="form-select">
      <option value="ALL">All Classes</option>
      {% for cls in all_classes %}
        <option value="{{ cls }}" {% if selected_class == cls %}selected{% endif %}>
          {{ cls }}
        </option>
      {% endfor %}
    </select>
  </div>

  <div class="col-md-12">
    <button class="btn btn-primary w-100">Apply</button>
  </div>

</form>

<!-- KPIs -->
<div class="row mb-4">
  <div class="col-md-3"><div class="card p-3 text-center">Total Students<br><b>{{ total_students }}</b></div></div>
  <div class="col-md-3"><div class="card p-3 text-center text-success">Present<br><b>{{ total_present }}</b></div></div>
  <div class="col-md-3"><div class="card p-3 text-center text-danger">Absent<br><b>{{ total_absent }}</b></div></div>
  <div class="col-md-3"><div class="card p-3 text-center text-warning">Attendance %<br><b>{{ attendance_percentage }}%</b></div></div>
</div>

<!-- CLASS TABLE + PIE -->
<div class="row mb-4">

  <div class="col-md-7">
    <div class="card p-3">
      <h5>ğŸ“Š Class-wise Attendance</h5>
      <table class="table table-bordered">
        <tr>
          <th>Class</th><th>Total</th><th>Present</th><th>Absent</th><th>%</th><th>Drill</th>
        </tr>
        {% for row in class_totals %}
        <tr>
          <td>{{ row.class_name }} ({{ row.sections }})</td>
          <td>{{ row.total }}</td>
          <td class="text-success">{{ row.present }}</td>
          <td class="text-danger">{{ row.absent }}</td>
          <td>{{ row.percent }}%</td>
          <td>
            <a href="{% url 'class_drill_dashboard' %}?class_name={{ row.class_name }}&snapshot_month={{ snapshot_month }}">
              View â†’
            </a>
          </td>
        </tr>
        {% endfor %}
      </table>
    </div>
  </div>

  <div class="col-md-5">
    <div class="card p-3">
      <h5>Present vs Absent</h5>
      <canvas id="pieChart"></canvas>
    </div>
  </div>

</div>

<!-- REGULAR ABSENTEES -->
<div class="card p-3 mb-4">
<h5>ğŸš¨ Regular Absentees (â‰¥ 3 days)</h5>
<table class="table table-bordered">
<tr><th>Class</th><th>No. of Students</th></tr>
{% for r in regular_absentees %}
<tr>
  <td>{{ r.class_name }}</td>
  <td>
    <a href="{% url 'regular_absent_drill' %}?class_name={{ r.class_name }}&snapshot_month={{ snapshot_month }}">
      <b>{{ r.count }}</b>
    </a>
  </td>
</tr>
{% endfor %}
</table>
</div>

<!-- TREND -->
<div class="card p-3">
<h5>ğŸ“ˆ Day-wise Attendance Trend</h5>
<canvas id="trendChart"></canvas>
</div>

</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
new Chart(document.getElementById('pieChart'),{
  type:'doughnut',
  data:{
    labels:['Present','Absent'],
    datasets:[{
      data:[{{ total_present }},{{ total_absent }}],
      backgroundColor:['#16a34a','#dc2626']
    }]
  }
});

new Chart(document.getElementById('trendChart'),{
  type:'line',
  data:{
    labels: {{ trend_labels|safe }},
    datasets:[{
      label:'Present',
      data: {{ trend_data|safe }},
      borderColor:'#2563eb',
      tension:0.3
    }]
  }
});
</script>

{% endblock %}
